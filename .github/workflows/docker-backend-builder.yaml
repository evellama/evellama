name: Build backend builder image

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
    paths:
      - .github/workflows/docker-backend-builder.yaml
      - docker/backend-builder/**
  workflow_dispatch:

jobs:
  publish-builder-image:
    name: Build and publish builder image
    permissions:
      packages: write
    runs-on: 'ubuntu-22.04'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Log in to registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $ --password-stdin
      - name: Extract metadata for builder image
        id: meta-builder
        uses: docker/metadata-action@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          images: ghcr.io/evellama/evellama-backend-builder
          tags: |
            type=edge,branch=main
          labels: |
            org.opencontainers.image.title=evellama-backend-builder
            org.opencontainers.image.description="EVE Llama backend builder image (not for deployment)"
            org.opencontainers.image.vendor="EVE Llama"
            org.opencontainers.image.documentation="https://github.com/evellama/evellama/blob/main/scripts/images/docker/backend-builder/README.md"
            org.opencontainers.image.source="https://github.com/evellama/evellama/tree/main/scripts/images/docker/backend-builder"
            org.opencontainers.image.licenses="MIT"
      - name: Build and push builder image
        uses: docker/build-push-action@v2
        with:
          context: .
          dockerfile: docker/backend-builder/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-builder.outputs.tags }}
          labels: ${{ steps.meta-builder.outputs.labels }}
